<div id="dashboardSection" class="result-section" style="padding: 36px 0; border-top: 2px solid rgba(212, 175, 55, 0.2); margin-top: 36px;">
    <div style="display: flex; gap: 40px; align-items: center; flex-wrap: wrap;">
        <div style="width: 400px; max-width: 48%; text-align: center; padding: 24px; background: rgba(15, 23, 42, 0.5); border-radius: 20px; border: 1px solid rgba(212, 175, 55, 0.15);">
            <svg id="gaugeSvg" viewBox="0 0 200 120" preserveAspectRatio="xMidYMid meet" style="width: 100%; height: 240px;">
                <path id="gaugeArcBg" d="M20,100 A80,80 0 0 1 180,100" stroke="rgba(255,255,255,0.08)" stroke-width="18" fill="none" stroke-linecap="round"/>
                <path id="gaugeArcFg" d="M20,100 A80,80 0 0 1 180,100" stroke="#22c55e" stroke-width="18" fill="none" stroke-linecap="round" stroke-dasharray="0" stroke-dashoffset="0"/>
                <line id="gaugeNeedle" x1="100" y1="100" x2="100" y2="24" stroke="#d4af37" stroke-width="6" stroke-linecap="round"/>
                <circle cx="100" cy="100" r="10" fill="#d4af37"/>
                <text id="gaugeValue" x="100" y="78" fill="#fff" font-size="36" font-weight="800" text-anchor="middle"></text>
            </svg>
        </div>

        <div style="flex: 1; min-width: 320px; display: flex; flex-direction: column; align-items: center; gap: 20px;">
            <div style="text-align: center;">
                <h2 style="margin: 0; font-size: 26px; color: #fff; font-weight: 800;">Fraud Probability: <span id="probText">{{ probability }}%</span></h2>
                <div id="riskBadge" class="risk-badge" style="display: inline-block; padding: 12px 24px; border-radius: 14px; font-weight: 700;"></div>
            </div>

            <div style="margin-top: 12px; display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                <button id="downloadPdfBtn" type="button" class="btn" style="background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; padding: 14px 24px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 15px;">
                    <i class="fa-solid fa-file-pdf"></i> Download PDF Report
                </button>
                <button id="raiseInvestBtn" type="button" class="btn" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; padding: 14px 24px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 15px;">
                    <i class="fa-solid fa-user-secret"></i> Raise Investigation
                </button>
            </div>
            <a href="/dashboard" style="color: #d4af37; text-decoration: none; font-size: 15px; font-weight: 600; margin-top: 8px;">
                <i class="fa-solid fa-chart-line"></i> View Dashboard
            </a>
        </div>
    </div>

</div>

<script>
(function(){
    const btn = document.getElementById('raiseInvestBtn');

    function createModal() {
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.85); display:flex; align-items:center; justify-content:center; z-index:2200;';

        const dialog = document.createElement('div');
        dialog.style.cssText = 'background:linear-gradient(145deg, #1e293b 0%, #0f172a 100%); padding:32px; width:500px; max-width:94%; border-radius:20px; box-shadow:0 25px 60px rgba(0,0,0,0.5); color:#e2e8f0; border:1px solid rgba(212, 175, 55, 0.2);';

        const title = document.createElement('h3');
        title.style.marginTop = '0';
        title.style.color = '#d4af37';
        title.innerHTML = '<i class="fa-solid fa-user-secret"></i> Raise Investigation';

        const formWrap = document.createElement('div');
        formWrap.style.cssText = 'margin-top:20px; display:flex; flex-direction:column; gap:14px;';

        const inputWho = document.createElement('input');
        inputWho.placeholder = 'Raised By (name or team)';
        inputWho.style.cssText = 'padding:16px 18px; border-radius:12px; border:1px solid rgba(212, 175, 55, 0.2); background:rgba(15, 23, 42, 0.6); color:#fff;';

        const inputDesc = document.createElement('textarea');
        inputDesc.placeholder = 'Description';
        inputDesc.rows = 4;
        inputDesc.style.cssText = 'padding:16px 18px; border-radius:12px; border:1px solid rgba(212, 175, 55, 0.2); background:rgba(15, 23, 42, 0.6); color:#fff;';

        formWrap.appendChild(inputWho);
        formWrap.appendChild(inputDesc);

        const actions = document.createElement('div');
        actions.style.cssText = 'margin-top:20px; display:flex; gap:12px; justify-content:flex-end;';

        const btnCancel = document.createElement('button');
        btnCancel.type = 'button';
        btnCancel.style.cssText = 'background:transparent; color:#94a3b8; border:1px solid rgba(212, 175, 55, 0.3); padding:12px 20px; border-radius:12px; cursor:pointer; font-weight:600;';
        btnCancel.innerText = 'Cancel';

        const btnSubmit = document.createElement('button');
        btnSubmit.type = 'button';
        btnSubmit.style.cssText = 'background:linear-gradient(135deg, #ef4444, #dc2626); color:#fff; padding:12px 20px; border-radius:12px; border:none; cursor:pointer; font-weight:700;';
        btnSubmit.innerText = 'Submit';

        actions.appendChild(btnCancel);
        actions.appendChild(btnSubmit);

        dialog.appendChild(title);
        dialog.appendChild(formWrap);
        dialog.appendChild(actions);
        overlay.appendChild(dialog);

        document.body.appendChild(overlay);

        function showConfirmation(message) {
            const confOverlay = document.createElement('div');
            confOverlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.85); display:flex; align-items:center; justify-content:center; z-index:2400;';
            const confBox = document.createElement('div');
            confBox.style.cssText = 'background:linear-gradient(145deg, #1e293b 0%, #0f172a 100%); padding:28px; width:440px; max-width:92%; border-radius:20px; box-shadow:0 25px 60px rgba(0,0,0,0.5); color:#e2e8f0; text-align:center; border:1px solid rgba(212, 175, 55, 0.2);';
            const h = document.createElement('h3'); h.style.marginTop='0'; h.style.color='#22c55e'; h.innerHTML='<i class="fa-solid fa-check-circle"></i> Investigation Raised';
            const p = document.createElement('p'); p.style.color='#94a3b8'; p.innerText = message || 'The investigation case has been created.';
            const closeWrap = document.createElement('div'); closeWrap.style.marginTop='20px';
            const closeBtn = document.createElement('button'); closeBtn.type='button'; closeBtn.style.cssText='background:linear-gradient(135deg, #d4af37, #b8960c); color:#0a0e1a; padding:12px 24px; border-radius:12px; border:none; cursor:pointer; font-weight:700;'; closeBtn.innerText='Close';
            closeWrap.appendChild(closeBtn);
            confBox.appendChild(h); confBox.appendChild(p); confBox.appendChild(closeWrap);
            confOverlay.appendChild(confBox);
            document.body.appendChild(confOverlay);
            closeBtn.addEventListener('click', ()=>{ document.body.removeChild(confOverlay); });
        }

        btnCancel.addEventListener('click', ()=>{ document.body.removeChild(overlay); });

        btnSubmit.addEventListener('click', async ()=>{
            const who = inputWho.value.trim();
            const description = inputDesc.value.trim();
            if (!who) { alert('Please enter who raised the complaint.'); return; }
            try {
                const res = await fetch('/investigation', {
                    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ raised_by: who, description })
                });
                const json = await res.json();
                document.body.removeChild(overlay);
                showConfirmation(json.message || ('Investigation raised by ' + who));
            } catch (e) {
                alert('Failed to raise investigation: ' + e.message);
            }
        });
    }

    if (btn) btn.addEventListener('click', ()=>{ createModal(); });

    const probVal = {{ probability|default('null') }};
    const lowUpper = Number({{ (risk_thresholds.low_upper if risk_thresholds is defined else 40)|tojson }});
    const highLower = Number({{ (risk_thresholds.high_lower if risk_thresholds is defined else 70)|tojson }});
    const riskFromBackend = {{ (risk if risk is defined else '')|tojson }};
    if (probVal !== null) {
        const gaugeArc = document.getElementById('gaugeArcFg');
        const gaugeNeedle = document.getElementById('gaugeNeedle');
        const gaugeValue = document.getElementById('gaugeValue');
        const badge = document.getElementById('riskBadge');
        const prob = Number(probVal);
        if (gaugeArc && gaugeNeedle && gaugeValue) {
            setTimeout(()=>{
                const length = gaugeArc.getTotalLength();
                gaugeArc.style.strokeDasharray = length;
                gaugeArc.style.transition = 'stroke-dashoffset 1s ease-in-out, stroke 0.6s';
                gaugeArc.style.strokeDashoffset = length * (1 - prob/100);

                const cx = 100, cy = 100, r = 72;
                const angleDeg = 180 * (1 - prob/100);
                const angleRad = angleDeg * Math.PI / 180;
                const x2 = cx + r * Math.cos(angleRad);
                const y2 = cy - r * Math.sin(angleRad);
                gaugeNeedle.setAttribute('x2', x2);
                gaugeNeedle.setAttribute('y2', y2);
                gaugeNeedle.style.transition = 'x2 0.9s ease-in-out, y2 0.9s ease-in-out, stroke 0.6s';

                gaugeValue.innerHTML = prob + '%';

                const color = prob < lowUpper ? '#22c55e' : (prob < highLower ? '#f59e0b' : '#ef4444');
                if (riskFromBackend) {
                    if (riskFromBackend.toLowerCase().startsWith('low')) {
                        badge.style.background = 'rgba(34, 197, 94, 0.25)';
                        badge.style.color = '#22c55e';
                        badge.innerHTML = 'Low Risk';
                    } else if (riskFromBackend.toLowerCase().startsWith('high')) {
                        badge.style.background = 'rgba(239, 68, 68, 0.25)';
                        badge.style.color = '#ef4444';
                        badge.innerHTML = 'High Risk - Investigation Required';
                    } else {
                        badge.style.background = 'rgba(245, 158, 11, 0.25)';
                        badge.style.color = '#f59e0b';
                        badge.innerHTML = 'Medium Risk';
                    }
                } else if (prob < lowUpper) {
                    badge.style.background = 'rgba(34, 197, 94, 0.25)';
                    badge.style.color = '#22c55e';
                    badge.innerHTML = 'Low Risk';
                } else if (prob < highLower) {
                    badge.style.background = 'rgba(245, 158, 11, 0.25)';
                    badge.style.color = '#f59e0b';
                    badge.innerHTML = 'Medium Risk';
                } else {
                    badge.style.background = 'rgba(239, 68, 68, 0.25)';
                    badge.style.color = '#ef4444';
                    badge.innerHTML = 'High Risk - Investigation Required';
                }
                gaugeArc.style.stroke = color;
                gaugeNeedle.style.stroke = color;

                const section = document.getElementById('dashboardSection');
                if (section) section.style.display = 'block';
                if (section) section.scrollIntoView({ behavior: 'smooth' });
            }, 150);
        }
    }

    const downloadBtn = document.getElementById('downloadPdfBtn');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', ()=>{
            function qs(name){ const el = document.querySelector(`[name="${name}"]`); return el ? el.value : ''; }
            const params = new URLSearchParams();
            params.set('probability', document.getElementById('probText') ? document.getElementById('probText').innerText : '');
            params.set('risk', document.getElementById('riskBadge') ? document.getElementById('riskBadge').innerText : '');
            const fields = ['months_as_customer','age','policy_annual_premium','umbrella_limit','total_claim_amount','injury_claim','property_claim','vehicle_claim'];
            fields.forEach(f=> params.set(f, qs(f)));
            const insights = Array.from(document.querySelectorAll('#dashboardSection ul li')).map(li=>li.innerText).join(' || ');
            params.set('insights', insights);

            window.location.href = '/download_pdf?' + params.toString();
        });
    }
})();
</script>
