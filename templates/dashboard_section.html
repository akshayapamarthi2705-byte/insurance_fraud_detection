<div id="dashboardSection" class="result-section" style="padding:18px 0;">
    <div style="display:flex; gap:28px; align-items:center; flex-wrap:wrap;">
        <div style="width:420px; max-width:48%; text-align:center;">
            <svg id="gaugeSvg" viewBox="0 0 200 120" preserveAspectRatio="xMidYMid meet" style="width:100%; height:220px;">
                <path id="gaugeArcBg" d="M20,100 A80,80 0 0 1 180,100" stroke="rgba(255,255,255,0.12)" stroke-width="16" fill="none" stroke-linecap="round"/>
                <path id="gaugeArcFg" d="M20,100 A80,80 0 0 1 180,100" stroke="#2ecc71" stroke-width="16" fill="none" stroke-linecap="round" stroke-dasharray="0" stroke-dashoffset="0"/>
                <line id="gaugeNeedle" x1="100" y1="100" x2="100" y2="24" stroke="#111" stroke-width="6" stroke-linecap="round"/>
                <circle cx="100" cy="100" r="8" fill="#111"/>
                <text id="gaugeValue" x="100" y="78" fill="white" font-size="34" font-weight="700" text-anchor="middle"></text>
            </svg>
        </div>

        <div style="flex:1; min-width:320px; display:flex; flex-direction:column; align-items:center; gap:12px;">
            <div style="text-align:center;">
                <h2 style="margin:0; font-size:22px; color:white; font-weight:700;">Fraud Probability: <span id="probText">{{ probability }}%</span></h2>
                <div id="riskBadge" class="risk-badge" style="display:inline-block; margin-top:12px; padding:10px 18px; border-radius:20px; font-weight:700;"></div>
            </div>

            <div style="margin-top:8px; display:flex; gap:14px;">
                <button id="downloadPdfBtn" type="button" class="btn" style="background:#2ecc71; color:black; padding:10px 18px; border-radius:8px; font-weight:700;">Download PDF Report</button>
                <button id="raiseInvestBtn" type="button" class="btn" style="background:#e74c3c; color:white; padding:10px 18px; border-radius:8px; border:none; cursor:pointer; font-weight:700;">Raise Investigation</button>
            </div>

        </div>
    </div>

    <div style="margin-top:22px; width:100%;">
        <h3 style="color:white; font-size:18px;">Explainable AI Insights</h3>
        <ul style="color:white; margin-left:20px;">
            <li>Warning: High claim-to-premium ratio - Suspicious pattern detected</li>
            <li>Standard claim pattern</li>
        </ul>
    </div>
</div>

<script>
(function(){
    const btn = document.getElementById('raiseInvestBtn');

    function createModal() {
        // overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.72); display:flex; align-items:center; justify-content:center; z-index:2200;';

        const dialog = document.createElement('div');
        dialog.style.cssText = 'background:rgba(255,255,255,0.98); padding:22px; width:480px; max-width:94%; border-radius:12px; box-shadow:0 18px 60px rgba(0,0,0,0.6); color:#0b1b18;';

        const title = document.createElement('h3');
        title.style.marginTop = '0';
        title.style.color = '#0b1b18';
        title.innerText = 'Raise Investigation';

        const formWrap = document.createElement('div');
        formWrap.style.cssText = 'margin-top:8px; display:flex; flex-direction:column; gap:10px;';

        const inputWho = document.createElement('input');
        inputWho.placeholder = 'Raised By (name or team)';
        inputWho.style.cssText = 'padding:12px 14px; border-radius:8px; border:1px solid rgba(11,27,24,0.08); background:rgba(255,255,255,0.98); color:#0b1b18;';

        const inputDesc = document.createElement('textarea');
        inputDesc.placeholder = 'Description';
        inputDesc.rows = 4;
        inputDesc.style.cssText = 'padding:12px 14px; border-radius:8px; border:1px solid rgba(11,27,24,0.08); background:rgba(255,255,255,0.98); color:#0b1b18;';

        formWrap.appendChild(inputWho);
        formWrap.appendChild(inputDesc);

        const actions = document.createElement('div');
        actions.style.cssText = 'margin-top:12px; display:flex; gap:8px; justify-content:flex-end;';

        const btnCancel = document.createElement('button');
        btnCancel.type = 'button';
        btnCancel.className = 'btn';
        btnCancel.style.cssText = 'background:transparent; color:#0b1b18; border:1px solid rgba(11,27,24,0.08); padding:8px 14px; border-radius:8px;';
        btnCancel.innerText = 'Cancel';

        const btnSubmit = document.createElement('button');
        btnSubmit.type = 'button';
        btnSubmit.className = 'btn';
        btnSubmit.style.cssText = 'background:#e74c3c; color:white; padding:8px 14px; border-radius:8px;';
        btnSubmit.innerText = 'Submit';

        actions.appendChild(btnCancel);
        actions.appendChild(btnSubmit);

        dialog.appendChild(title);
        dialog.appendChild(formWrap);
        dialog.appendChild(actions);
        overlay.appendChild(dialog);

        document.body.appendChild(overlay);

        // confirmation dialog builder
        function showConfirmation(message) {
            const confOverlay = document.createElement('div');
            confOverlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:2400;';
            const confBox = document.createElement('div');
            confBox.style.cssText = 'background:rgba(255,255,255,0.98); padding:18px; width:420px; max-width:92%; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.6); color:#0b1b18; text-align:center;';
            const h = document.createElement('h3'); h.style.marginTop='0'; h.style.color='#0b1b18'; h.innerText='Investigation Raised';
            const p = document.createElement('p'); p.style.color='#0b1b18'; p.innerText = message || 'The investigation case has been created.';
            const closeWrap = document.createElement('div'); closeWrap.style.marginTop='12px';
            const closeBtn = document.createElement('button'); closeBtn.type='button'; closeBtn.className='btn'; closeBtn.style.cssText='background:#f9a826;color:black;padding:8px 14px;border-radius:8px;'; closeBtn.innerText='Close';
            closeWrap.appendChild(closeBtn);
            confBox.appendChild(h); confBox.appendChild(p); confBox.appendChild(closeWrap);
            confOverlay.appendChild(confBox);
            document.body.appendChild(confOverlay);
            closeBtn.addEventListener('click', ()=>{ document.body.removeChild(confOverlay); });
        }

        // handlers
        btnCancel.addEventListener('click', ()=>{ document.body.removeChild(overlay); });

        btnSubmit.addEventListener('click', async ()=>{
            const who = inputWho.value.trim();
            const description = inputDesc.value.trim();
            if (!who) { alert('Please enter who raised the complaint.'); return; }
            try {
                const res = await fetch('/investigation', {
                    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ raised_by: who, description })
                });
                const json = await res.json();
                document.body.removeChild(overlay);
                showConfirmation(json.message || ('Investigation raised by ' + who));
            } catch (e) {
                alert('Failed to raise investigation: ' + e.message);
            }
        });
    }

    if (btn) btn.addEventListener('click', ()=>{ createModal(); });

    // Gauge animation helper (when probability is present)
    const probVal = {{ probability|default('null') }};
    if (probVal !== null) {
        const gaugeArc = document.getElementById('gaugeArcFg');
        const gaugeNeedle = document.getElementById('gaugeNeedle');
        const gaugeValue = document.getElementById('gaugeValue');
        const badge = document.getElementById('riskBadge');
        const prob = Number(probVal);
        if (gaugeArc && gaugeNeedle && gaugeValue) {
            setTimeout(()=>{
                const length = gaugeArc.getTotalLength();
                gaugeArc.style.strokeDasharray = length;
                gaugeArc.style.transition = 'stroke-dashoffset 1s ease-in-out, stroke 0.6s';
                gaugeArc.style.strokeDashoffset = length * (1 - prob/100);

                const cx = 100, cy = 100, r = 72;
                const angleDeg = 180 * (1 - prob/100);
                const angleRad = angleDeg * Math.PI / 180;
                const x2 = cx + r * Math.cos(angleRad);
                const y2 = cy - r * Math.sin(angleRad);
                gaugeNeedle.setAttribute('x2', x2);
                gaugeNeedle.setAttribute('y2', y2);
                gaugeNeedle.style.transition = 'x2 0.9s ease-in-out, y2 0.9s ease-in-out, stroke 0.6s';

                gaugeValue.innerHTML = prob + '%';

                let color = '#2ecc71';
                if (prob < 40) {
                    color = '#2ecc71';
                    badge.style.background = '#2ecc71';
                    badge.innerHTML = 'Low Risk';
                } else if (prob < 70) {
                    color = '#f39c12';
                    badge.style.background = '#f39c12';
                    badge.innerHTML = 'Medium Risk';
                } else {
                    color = '#e74c3c';
                    badge.style.background = '#e74c3c';
                    badge.innerHTML = 'High Risk - Investigation Required';
                }

                gaugeArc.style.stroke = color;
                gaugeNeedle.style.stroke = color;

                // ensure section visible and scroll
                const section = document.getElementById('dashboardSection');
                if (section) section.style.display = 'block';
                if (section) section.scrollIntoView({ behavior: 'smooth' });
            }, 150);
        }
    }

    // Download button: gather form values + probability + insights and navigate to download route
    const downloadBtn = document.getElementById('downloadPdfBtn');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', ()=>{
            // read values from form fields on the page
            function qs(name){ const el = document.querySelector(`[name="${name}"]`); return el ? el.value : ''; }
            const params = new URLSearchParams();
            params.set('probability', document.getElementById('probText') ? document.getElementById('probText').innerText : '');
            params.set('risk', document.getElementById('riskBadge') ? document.getElementById('riskBadge').innerText : '');
            // add form fields
            const fields = ['months_as_customer','age','policy_annual_premium','umbrella_limit','total_claim_amount','injury_claim','property_claim','vehicle_claim'];
            fields.forEach(f=> params.set(f, qs(f)));
            // include AI insights text
            const insights = Array.from(document.querySelectorAll('#dashboardSection ul li')).map(li=>li.innerText).join(' || ');
            params.set('insights', insights);

            const url = '/download_pdf?' + params.toString();
            window.location.href = url;
        });
    }
})();
</script>